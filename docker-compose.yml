# Production-ready Docker Compose for Petbot
# NOTE: Do NOT commit secrets or concrete ALLOWED_IMAGE_HOSTS values. Use an override file or `.env` for sensitive values.
version: "3.8"

services:
  petbot:
    container_name: petbot-bot
    # Bot image (server-only)
    image: "${BOT_IMAGE:-ghcr.io/rustedaperture/petbot-bot:latest}"
    restart: unless-stopped
    working_dir: /home/node/app
    env_file:
      - .env
    environment:
      # Internal API secret (optional) â€” recommended in production
      - INTERNAL_API_SECRET=${INTERNAL_API_SECRET:-}

      # Discord OAuth (set these for the web UI to allow Sign in with Discord)
      - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID:-}
      - DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET:-}
      - NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL:-http://localhost:3000}
      - DISCORD_TOKEN=${DISCORD_TOKEN:-}

      # HTTP API bind settings (the bot's internal HTTP API)
      - HTTP_HOST=${HTTP_HOST:-127.0.0.1}
      - HTTP_PORT=${HTTP_PORT:-3001}

      # Optional / runtime config
      - DEFAULT_GUILD_ID=${DEFAULT_GUILD_ID:-}
      # Example: ALLOWED_IMAGE_HOSTS is optional and should not be committed
      # - ALLOWED_IMAGE_HOSTS=${ALLOWED_IMAGE_HOSTS:-}

      # Ensure the runtime runs in production mode by default
      - NODE_ENV=${NODE_ENV:-production}
    volumes:
      # Persist runtime data (sqlite DB, migrations, etc.)
      - ./data:/home/node/app/data

  petbot-web:
    container_name: petbot-web
    # Web image (Next.js only)
    image: "${WEB_IMAGE:-ghcr.io/rustedaperture/petbot-web:latest}"
    restart: unless-stopped
    working_dir: /home/node/app/apps/web
    env_file:
      - .env
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      # Ensure Next.js uses HTTP for the bot internal API inside Docker
      - INTERNAL_API_URL=http://petbot-bot:3001
      - INTERNAL_API_SECRET=${INTERNAL_API_SECRET:-}
      - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID:-}
      - DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET:-}
      - NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL:-http://localhost:3000}
      - DISCORD_TOKEN=${DISCORD_TOKEN:-}
      - DEFAULT_GUILD_ID=${DEFAULT_GUILD_ID:-}
    ports:
      - "3000:3000"
    volumes:
      - ./data:/home/node/app/data
    depends_on:
      - petbot

volumes:
  data:
    driver: local

# Example: docker-compose.override.yml (keep out of VCS / do not commit values)
# services:
#   petbot:
#     environment:
#       - ALLOWED_IMAGE_HOSTS=example.com,images.example.net

# Quick commands:
# - Build locally:     docker compose build petbot
# - Run in foreground: docker compose up --build
# - After `docker compose up`, open the web UI at http://localhost:3000
