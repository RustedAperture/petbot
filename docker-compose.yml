# Production-ready Docker Compose for Petbot
# NOTE: Do NOT commit secrets or concrete ALLOWED_IMAGE_HOSTS values. Use an override file or `.env` for sensitive values.
version: "3.8"

services:
  petbot:
    container_name: petbot
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    working_dir: /home/node/app
    environment:
      # DEV container is the default and will run both bot and web in dev mode
      - DEV=1
      # TUI: set to 1 or true to enable the interactive TUI (requires a TTY)
      - TUI=${TUI:-false}
      # Keep internal API bound to loopback by default
      - INTERNAL_HOST=127.0.0.1
    volumes:
      # Mount the repository into the container for live edits
      - ./:/home/node/app
      # Persist runtime data (sqlite DB, migrations, etc.)
      - ./data:/home/node/app/data
      # Mount your config.json (read-only). Create it locally as documented in README.
      - ./config.json:/home/node/app/config.json:ro
      # Preserve the container-installed node_modules (host mount would otherwise overwrite them)
      - node_modules:/home/node/app/node_modules
      - web_node_modules:/home/node/app/web/node_modules
    ports:
      - "3000:3000" # Next dev server
      # Note: INTERNAL_PORT (3030) remains internal by default; do NOT publish unless necessary.
    tty: ${TUI:-false}
    # The entrypoint will start both the bot and web when DEV=1; use docker compose up/build to run in dev mode.

volumes:
  data:
    driver: local
  node_modules: {}
  web_node_modules: {}

# Example: docker-compose.override.yml (keep out of VCS / do not commit values)
# services:
#   petbot:
#     environment:
#       - ALLOWED_IMAGE_HOSTS=example.com,images.example.net

# Quick commands:
# - Build locally:     docker compose build petbot
# - Run in foreground: docker compose up --build
# - Run TUI (one-off): TUI=1 docker compose run --service-ports --rm petbot
